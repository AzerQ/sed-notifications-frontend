# Настройки уведомлений

## Обзор

Реализована полная система настроек уведомлений, которая позволяет пользователям настраивать способы получения уведомлений для различных типов событий в системе.

## Новые компоненты и функциональность

### 1. Компонент NotificationSettings

**Расположение:** `src/NotificationsBar/NotificationSettings.tsx`

Модальное окно для управления настройками уведомлений пользователя:

- ✅ Отображение списка типов событий с описаниями
- ✅ Настройка каналов уведомлений для каждого события (Email, SMS, Push, В приложении)
- ✅ Раздельные настройки для себя и по замещению
- ✅ Сохранение и загрузка настроек
- ✅ Обработка ошибок и состояний загрузки
- ✅ Адаптивный дизайн

### 2. Расширенная боковая панель

**Изменения в:** `src/NotificationsBar/NotificationSidebar.tsx`

Добавлена кнопка "Настройки уведомлений" рядом с кнопкой "Вся история":

- ✅ Новая кнопка настроек с иконкой
- ✅ Интеграция с основным компонентом
- ✅ Обновленные тесты

### 3. Новые типы данных

**Расположение:** `src/NotificationsBar/types.ts`

Добавлены новые типы для настроек:

```typescript
// Каналы уведомлений
export type NotificationChannel = 'email' | 'sms' | 'push' | 'inApp';

// Группы настроек
export type NotificationSettingGroup = 'personal' | 'substitute';

// Настройка канала
export interface ChannelSetting {
    channel: NotificationChannel;
    enabled: boolean;
}

// Настройка события
export interface NotificationEventSetting {
    eventId: string; // Текстовый идентификатор события
    eventName: string; // Человекопонятное наименование
    eventDescription?: string; // Описание события
    personalSettings: ChannelSetting[]; // Настройки для себя
    substituteSettings: ChannelSetting[]; // Настройки по замещению
}

// Настройки пользователя
export interface UserNotificationSettings {
    userId: string;
    eventSettings: NotificationEventSetting[];
    lastUpdated: string;
}
```

### 4. Расширенный сервис уведомлений

**Изменения в:**
- `src/services/contracts/INotificationService.ts`
- `src/services/mocks/MockNotificationService.ts`
- `src/store/NotificationStore.ts`

Добавлены новые методы:

```typescript
interface INotificationService {
    // ... существующие методы
    
    /**
     * Получить настройки уведомлений пользователя
     */
    getUserNotificationSettings(): Promise<UserNotificationSettings>;

    /**
     * Сохранить настройки уведомлений пользователя
     */
    saveUserNotificationSettings(settings: UserNotificationSettings): Promise<void>;
}
```

### 5. Мок-данные

MockNotificationService теперь включает настройки по умолчанию для 5 типов событий:

1. **Создание документа** - уведомления о создании новых документов
2. **Согласование документа** - уведомления о процессах согласования
3. **Назначение задачи** - уведомления о новых назначенных задачах
4. **Выполнение задачи** - уведомления о завершении задач
5. **Техническое обслуживание** - системные уведомления

## Интеграция

### Главный компонент

**Изменения в:** `src/NotificationsBar/NotificationCenterWithStore.tsx`

- ✅ Добавлено состояние для модального окна настроек
- ✅ Интеграция обработчиков открытия/закрытия
- ✅ Подключение к store для работы с API

### Использование

```typescript
import { NotificationCenterWithStore } from './NotificationsBar';

// Компонент автоматически включает:
// - Колокольчик с количеством непрочитанных
// - Боковую панель с кнопками "История" и "Настройки"
// - Модальные окна для истории и настроек

<NotificationCenterWithStore />
```

## Тестирование

### Покрытие тестами

- ✅ **NotificationSettings.test.tsx** - 15 тестов
  - Отображение и закрытие модального окна
  - Загрузка и сохранение настроек
  - Обработка ошибок
  - Переключение настроек каналов
  - Состояния загрузки

- ✅ **NotificationSidebar.test.tsx** - обновлены существующие тесты
  - Добавлены тесты для кнопки настроек
  - Проверка интеграции с новым функционалом

### Запуск тестов

```bash
# Тесты для настроек
npm test -- --testNamePattern="NotificationSettings"

# Тесты для боковой панели
npm test -- --testNamePattern="NotificationSidebar"

# Все тесты
npm test
```

## UI/UX

### Дизайн-система

- ✅ Консистентный дизайн с существующими компонентами
- ✅ Использование Tailwind CSS классов
- ✅ Иконки из Lucide React
- ✅ Адаптивная верстка

### Цветовая схема

- **Кнопка настроек**: серый цвет (`bg-gray-600`) для отличия от синей кнопки истории
- **Группировка**: отдельные блоки для "Для себя" и "По замещению"
- **Состояния**: loading, error, success индикаторы

### Доступность

- ✅ Корректные ARIA-метки
- ✅ Поддержка клавиатурной навигации (Escape для закрытия)
- ✅ Семантическая разметка
- ✅ Test ID для автотестирования

## Производительность

- ✅ Ленивая загрузка настроек (только при открытии модального окна)
- ✅ Оптимизированные перерендеры через React.memo (если потребуется)
- ✅ Эффективное управление состоянием через MobX

## Расширяемость

Архитектура позволяет легко добавлять:

1. **Новые типы событий** - добавление в мок-сервис
2. **Новые каналы уведомлений** - расширение enum `NotificationChannel`
3. **Дополнительные настройки** - расширение интерфейса `ChannelSetting`
4. **Валидация** - добавление правил валидации в компонент

## Следующие шаги

Для production использования рекомендуется:

1. **Интеграция с реальным API** - замена мок-сервиса на HTTP-клиент
2. **Валидация данных** - добавление схем валидации (например, Yup/Zod)
3. **Кэширование** - оптимизация загрузки настроек
4. **Аналитика** - отслеживание изменений настроек пользователями
5. **Локализация** - поддержка множественных языков

## Архитектурные решения

### Паттерны

- **Observer Pattern** - через MobX для реактивного состояния
- **Service Layer** - для работы с API
- **Compound Components** - модульная структура компонентов

### Принципы

- **Single Responsibility** - каждый компонент имеет четкую ответственность
- **Open/Closed** - легко расширяется без изменения существующего кода
- **Dependency Inversion** - зависимости от абстракций, а не от конкретных классов